'use client'

import { useState } from 'react'
import { useTranslations } from 'next-intl'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter,
} from '@/components/ui/dialog'
import { Checkbox } from '@/components/ui/checkbox'
import { Textarea } from '@/components/ui/textarea'
import {
  Calendar,
  Plus,
  Clock,
  MapPin,
  Users,
  Edit,
  Trash2,
  Printer,
  ChevronLeft,
  ChevronRight,
  Save,
  X,
} from 'lucide-react'

// デモデータ - 講師
const demoCoaches = [
  { id: 'coach-1', name: 'Risa', color: '#ef4444' },
  { id: 'coach-2', name: 'Gicko', color: '#3b82f6' },
  { id: 'coach-3', name: 'Sapta', color: '#22c55e' },
  { id: 'coach-4', name: 'Aung', color: '#f59e0b' },
]

// デモデータ - レッスン時間帯
const ageoTimeSlots = [
  { id: 'ageo-1', time: '10:10-11:00', label: '10:10-11:00' },
  { id: 'ageo-2', time: '11:10-12:00', label: '11:10-12:00(幼児クラス)' },
  { id: 'ageo-3', time: '13:10-14:00', label: '13:10-14:00(小学生クラス)' },
]

const okegawaTimeSlots = [
  { id: 'oke-1', time: '9:05-9:55', label: '9:05-9:55' },
  { id: 'oke-2', time: '10:05-10:55', label: '10:05-10:55' },
  { id: 'oke-3', time: '11:30-12:30', label: '11:30-12:30' },
  { id: 'oke-4', time: '12:05-12:55', label: '12:05-12:55' },
]

// デモデータ - シフト
const initialShifts = [
  // 1/10 (土)
  { id: '1', date: '2025-01-10', school: 'ageo', timeSlot: 'ageo-2', coachId: 'coach-1', hasLesson: true },
  { id: '2', date: '2025-01-10', school: 'ageo', timeSlot: 'ageo-3', coachId: 'coach-1', hasLesson: true },
  { id: '3', date: '2025-01-10', school: 'okegawa', timeSlot: 'oke-1', coachId: 'coach-1', hasLesson: true },
  // 1/11 (日)
  { id: '4', date: '2025-01-11', school: 'ageo', timeSlot: 'ageo-1', coachId: 'coach-2', hasLesson: false },
  // 1/17 (土)
  { id: '5', date: '2025-01-17', school: 'ageo', timeSlot: 'ageo-1', coachId: 'coach-2', hasLesson: false },
  { id: '6', date: '2025-01-17', school: 'ageo', timeSlot: 'ageo-2', coachId: 'coach-1', hasLesson: true },
  { id: '7', date: '2025-01-17', school: 'ageo', timeSlot: 'ageo-3', coachId: 'coach-1', hasLesson: true },
  { id: '8', date: '2025-01-17', school: 'okegawa', timeSlot: 'oke-1', coachId: 'coach-1', hasLesson: true },
  // 1/18 (日)
  { id: '9', date: '2025-01-18', school: 'ageo', timeSlot: 'ageo-1', coachId: 'coach-1', hasLesson: false },
  { id: '10', date: '2025-01-18', school: 'ageo', timeSlot: 'ageo-1', coachId: 'coach-3', hasLesson: false },
  { id: '11', date: '2025-01-18', school: 'okegawa', timeSlot: 'oke-1', coachId: 'coach-3', hasLesson: true },
  // 1/24 (土)
  { id: '12', date: '2025-01-24', school: 'ageo', timeSlot: 'ageo-1', coachId: 'coach-3', hasLesson: false },
  { id: '13', date: '2025-01-24', school: 'ageo', timeSlot: 'ageo-2', coachId: 'coach-1', hasLesson: true },
  { id: '14', date: '2025-01-24', school: 'ageo', timeSlot: 'ageo-3', coachId: 'coach-2', hasLesson: true },
  { id: '15', date: '2025-01-24', school: 'okegawa', timeSlot: 'oke-1', coachId: 'coach-3', hasLesson: true },
  // 1/25 (日)
  { id: '16', date: '2025-01-25', school: 'ageo', timeSlot: 'ageo-1', coachId: 'coach-3', hasLesson: false },
  { id: '17', date: '2025-01-25', school: 'okegawa', timeSlot: 'oke-2', coachId: 'coach-2', hasLesson: true },
  // 1/31 (土)
  { id: '18', date: '2025-01-31', school: 'ageo', timeSlot: 'ageo-2', coachId: 'coach-1', hasLesson: true },
  { id: '19', date: '2025-01-31', school: 'ageo', timeSlot: 'ageo-3', coachId: 'coach-1', hasLesson: true },
  { id: '20', date: '2025-01-31', school: 'okegawa', timeSlot: 'oke-1', coachId: 'coach-1', hasLesson: true },
]

interface ShiftFormData {
  date: string
  school: 'ageo' | 'okegawa' | ''
  timeSlot: string
  coachId: string
  hasLesson: boolean
  notes: string
}

export default function ShiftsPage() {
  const [currentMonth, setCurrentMonth] = useState(new Date(2025, 0, 1)) // 2025年1月
  const tShifts = useTranslations('schedule.shifts')
  const tCommon = useTranslations('common')
  const [shifts, setShifts] = useState(initialShifts)
  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false)
  const [editingShift, setEditingShift] = useState<typeof initialShifts[0] | null>(null)
  const [formData, setFormData] = useState<ShiftFormData>({
    date: '',
    school: '',
    timeSlot: '',
    coachId: '',
    hasLesson: true,
    notes: '',
  })

  // 月の土日を取得
  const getWeekendsInMonth = (date: Date) => {
    const year = date.getFullYear()
    const month = date.getMonth()
    const weekends: Date[] = []
    
    const daysInMonth = new Date(year, month + 1, 0).getDate()
    
    for (let day = 1; day <= daysInMonth; day++) {
      const d = new Date(year, month, day)
      const dayOfWeek = d.getDay()
      if (dayOfWeek === 0 || dayOfWeek === 6) { // 土日
        weekends.push(d)
      }
    }
    
    return weekends
  }

  const weekends = getWeekendsInMonth(currentMonth)

  // シフトを取得
  const getShiftsForCell = (date: string, school: string, timeSlot: string) => {
    return shifts.filter(s => 
      s.date === date && 
      s.school === school && 
      s.timeSlot === timeSlot
    )
  }

  // 日付をフォーマット
  const formatDate = (date: Date) => {
    return date.toISOString().split('T')[0]
  }

  // 曜日を取得
  const getDayOfWeek = (date: Date) => {
    const days = ['日', '月', '火', '水', '木', '金', '土']
    return days[date.getDay()]
  }

  // コーチ名を取得
  const getCoachName = (coachId: string) => {
    return demoCoaches.find(c => c.id === coachId)?.name || ''
  }

  const getCoachColor = (coachId: string) => {
    return demoCoaches.find(c => c.id === coachId)?.color || '#666'
  }

  // 月を変更
  const goToPreviousMonth = () => {
    setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1))
  }

  const goToNextMonth = () => {
    setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1))
  }

  // シフト追加
  const handleAddShift = () => {
    if (!formData.date || !formData.school || !formData.timeSlot || !formData.coachId) {
      alert(tShifts('requiredFields'))
      return
    }

    const newShift = {
      id: `shift-${Date.now()}`,
      date: formData.date,
      school: formData.school,
      timeSlot: formData.timeSlot,
      coachId: formData.coachId,
      hasLesson: formData.hasLesson,
    }

    setShifts(prev => [...prev, newShift])
    setIsAddDialogOpen(false)
    resetForm()
  }

  // シフト削除
  const handleDeleteShift = (shiftId: string) => {
    if (confirm(tShifts('deleteConfirm'))) {
      setShifts(prev => prev.filter(s => s.id !== shiftId))
    }
  }

  // フォームリセット
  const resetForm = () => {
    setFormData({
      date: '',
      school: '',
      timeSlot: '',
      coachId: '',
      hasLesson: true,
      notes: '',
    })
  }

  // セル内のシフト表示
  const renderCellContent = (date: string, school: string, timeSlot: string) => {
    const cellShifts = getShiftsForCell(date, school, timeSlot)
    
    if (cellShifts.length === 0) return null

    return (
      <div className="flex flex-wrap gap-1 justify-center items-center">
        {cellShifts.map(shift => (
          <div 
            key={shift.id}
            className="flex items-center gap-1 group cursor-pointer"
            onClick={() => {
              setEditingShift(shift)
            }}
          >
            {shift.hasLesson && (
              <span 
                className="text-red-500 font-bold text-lg"
                style={{ color: getCoachColor(shift.coachId) }}
              >
                ○
              </span>
            )}
            <span 
              className="text-xs font-medium"
              style={{ color: getCoachColor(shift.coachId) }}
            >
              {getCoachName(shift.coachId)}
            </span>
          </div>
        ))}
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* ヘッダー */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">{tShifts('title')}</h1>
          <p className="text-muted-foreground mt-2">
            {tShifts('subtitle')}
          </p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => window.print()}>
            <Printer className="h-4 w-4 mr-2" />
            {tShifts('print')}
          </Button>
          <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>
            <DialogTrigger asChild>
              <Button>
                <Plus className="h-4 w-4 mr-2" />
                {tShifts('addShift')}
              </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[500px]">
              <DialogHeader>
                <DialogTitle>{tShifts('newShift')}</DialogTitle>
              </DialogHeader>
              <div className="space-y-4 py-4">
                <div className="space-y-2">
                  <Label htmlFor="date">{tShifts('date')} *</Label>
                  <Input
                    id="date"
                    type="date"
                    value={formData.date}
                    onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}
                  />
                </div>

                <div className="space-y-2">
                  <Label>{tShifts('school')} *</Label>
                  <Select
                    value={formData.school}
                    onValueChange={(value: 'ageo' | 'okegawa') => {
                      setFormData(prev => ({ ...prev, school: value, timeSlot: '' }))
                    }}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder={tShifts('selectSchool')} />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="ageo">上尾校</SelectItem>
                      <SelectItem value="okegawa">桶川校</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>{tShifts('timeSlot')} *</Label>
                  <Select
                    value={formData.timeSlot}
                    onValueChange={(value) => setFormData(prev => ({ ...prev, timeSlot: value }))}
                    disabled={!formData.school}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder={tShifts('selectTimeSlot')} />
                    </SelectTrigger>
                    <SelectContent>
                      {(formData.school === 'ageo' ? ageoTimeSlots : okegawaTimeSlots).map(slot => (
                        <SelectItem key={slot.id} value={slot.id}>
                          {slot.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>{tShifts('coach')} *</Label>
                  <Select
                    value={formData.coachId}
                    onValueChange={(value) => setFormData(prev => ({ ...prev, coachId: value }))}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder={tShifts('selectCoach')} />
                    </SelectTrigger>
                    <SelectContent>
                      {demoCoaches.map(coach => (
                        <SelectItem key={coach.id} value={coach.id}>
                          <div className="flex items-center gap-2">
                            <div 
                              className="w-3 h-3 rounded-full"
                              style={{ backgroundColor: coach.color }}
                            />
                            {coach.name}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="flex items-center space-x-2">
                  <Checkbox
                    id="hasLesson"
                    checked={formData.hasLesson}
                    onCheckedChange={(checked: boolean) => 
                      setFormData(prev => ({ ...prev, hasLesson: checked }))
                    }
                  />
                  <Label htmlFor="hasLesson">{tShifts('lessonAssignment')}</Label>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="notes">{tShifts('notes')}</Label>
                  <Textarea
                    id="notes"
                    value={formData.notes}
                    onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                    placeholder={tShifts('notesPlaceholder')}
                    rows={2}
                  />
                </div>
              </div>
              <DialogFooter>
                <Button variant="outline" onClick={() => {
                  setIsAddDialogOpen(false)
                  resetForm()
                }}>
                  {tCommon('cancel')}
                </Button>
                <Button onClick={handleAddShift}>
                  <Save className="h-4 w-4 mr-2" />
                  {tShifts('add')}
                </Button>
              </DialogFooter>
            </DialogContent>
          </Dialog>
        </div>
      </div>

      {/* 月ナビゲーション */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex items-center justify-between">
            <Button variant="outline" size="sm" onClick={goToPreviousMonth}>
              <ChevronLeft className="h-4 w-4 mr-1" />
              {tShifts('previousMonth')}
            </Button>
            <h2 className="text-xl font-bold">
              {currentMonth.getFullYear()}{tShifts('year')}{currentMonth.getMonth() + 1}{tShifts('month')} {tShifts('shiftTable')}
            </h2>
            <Button variant="outline" size="sm" onClick={goToNextMonth}>
              {tShifts('nextMonth')}
              <ChevronRight className="h-4 w-4 ml-1" />
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* 講師凡例 */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex flex-wrap gap-4 items-center">
            <span className="text-sm font-medium text-muted-foreground">{tShifts('coach')}:</span>
            {demoCoaches.map(coach => (
              <div key={coach.id} className="flex items-center gap-2">
                <div 
                  className="w-4 h-4 rounded-full"
                  style={{ backgroundColor: coach.color }}
                />
                <span className="text-sm font-medium">{coach.name}</span>
              </div>
            ))}
            <span className="text-sm text-muted-foreground ml-4">
              {tShifts('lessonMark')}
            </span>
          </div>
        </CardContent>
      </Card>

      {/* シフト表 */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Calendar className="h-5 w-5" />
            {tShifts('shiftTable')}{tShifts('weekendsOnly')}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="overflow-x-auto">
            <table className="w-full border-collapse text-sm">
              <thead>
                <tr>
                  <th className="border p-2 bg-gray-100 text-left min-w-[150px]">{tShifts('shiftTable')}</th>
                  {weekends.map(date => (
                    <th 
                      key={formatDate(date)} 
                      className={`border p-2 min-w-[100px] ${
                        date.getDay() === 6 ? 'bg-blue-50' : 'bg-red-50'
                      }`}
                    >
                      <div className={`font-medium ${
                        date.getDay() === 6 ? 'text-blue-600' : 'text-red-600'
                      }`}>
                        {getDayOfWeek(date)}
                      </div>
                      <div className="text-xs text-gray-600">
                        {date.getMonth() + 1}/{date.getDate()}
                      </div>
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {/* 上尾校セクション */}
                <tr>
                  <td 
                    colSpan={weekends.length + 1} 
                    className="border p-2 bg-orange-100 font-bold text-orange-800"
                  >
                    <div className="flex items-center gap-2">
                      <MapPin className="h-4 w-4" />
                      Ageo（上尾校）
                    </div>
                  </td>
                </tr>
                {/* 上尾校の担当コーチ行 */}
                <tr className="bg-orange-50">
                  <td className="border p-2 text-muted-foreground text-xs">{tShifts('assignedCoach')}</td>
                  {weekends.map(date => {
                    const dateStr = formatDate(date)
                    const dayShifts = shifts.filter(s => s.date === dateStr && s.school === 'ageo')
                    const coaches = [...new Set(dayShifts.map(s => getCoachName(s.coachId)))]
                    return (
                      <td key={dateStr} className="border p-2 text-center text-xs">
                        {coaches.join(', ')}
                      </td>
                    )
                  })}
                </tr>
                {ageoTimeSlots.map(slot => (
                  <tr key={slot.id}>
                    <td className="border p-2 bg-gray-50">{slot.label}</td>
                    {weekends.map(date => (
                      <td 
                        key={`${formatDate(date)}-ageo-${slot.id}`} 
                        className="border p-2 text-center hover:bg-gray-50 cursor-pointer"
                        onClick={() => {
                          setFormData({
                            date: formatDate(date),
                            school: 'ageo',
                            timeSlot: slot.id,
                            coachId: '',
                            hasLesson: true,
                            notes: '',
                          })
                          setIsAddDialogOpen(true)
                        }}
                      >
                        {renderCellContent(formatDate(date), 'ageo', slot.id)}
                      </td>
                    ))}
                  </tr>
                ))}

                {/* 桶川校セクション */}
                <tr>
                  <td 
                    colSpan={weekends.length + 1} 
                    className="border p-2 bg-green-100 font-bold text-green-800"
                  >
                    <div className="flex items-center gap-2">
                      <MapPin className="h-4 w-4" />
                      Okegawa（{tShifts('okegawaSchool')}）{tShifts('preschoolOnly')}
                    </div>
                  </td>
                </tr>
                {/* 桶川校の担当コーチ行 */}
                <tr className="bg-green-50">
                  <td className="border p-2 text-muted-foreground text-xs">{tShifts('assignedCoach')}</td>
                  {weekends.map(date => {
                    const dateStr = formatDate(date)
                    const dayShifts = shifts.filter(s => s.date === dateStr && s.school === 'okegawa')
                    const coaches = [...new Set(dayShifts.map(s => getCoachName(s.coachId)))]
                    return (
                      <td key={dateStr} className="border p-2 text-center text-xs">
                        {coaches.join(', ')}
                      </td>
                    )
                  })}
                </tr>
                {okegawaTimeSlots.map(slot => (
                  <tr key={slot.id}>
                    <td className="border p-2 bg-gray-50">{slot.label}</td>
                    {weekends.map(date => (
                      <td 
                        key={`${formatDate(date)}-okegawa-${slot.id}`} 
                        className="border p-2 text-center hover:bg-gray-50 cursor-pointer"
                        onClick={() => {
                          setFormData({
                            date: formatDate(date),
                            school: 'okegawa',
                            timeSlot: slot.id,
                            coachId: '',
                            hasLesson: true,
                            notes: '',
                          })
                          setIsAddDialogOpen(true)
                        }}
                      >
                        {renderCellContent(formatDate(date), 'okegawa', slot.id)}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>

      {/* 統計 */}
      <div className="grid gap-4 md:grid-cols-4">
        <Card>
          <CardContent className="pt-6">
            <div className="text-center">
              <div className="text-2xl font-bold text-blue-600">{shifts.length}</div>
              <div className="text-xs text-muted-foreground">{tShifts('totalShifts')}</div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-center">
              <div className="text-2xl font-bold text-green-600">
                {shifts.filter(s => s.hasLesson).length}
              </div>
              <div className="text-xs text-muted-foreground">{tShifts('lessonAssignments')}</div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-center">
              <div className="text-2xl font-bold text-orange-600">
                {shifts.filter(s => s.school === 'ageo').length}
              </div>
              <div className="text-xs text-muted-foreground">{tShifts('ageoShifts')}</div>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-center">
              <div className="text-2xl font-bold text-purple-600">
                {shifts.filter(s => s.school === 'okegawa').length}
              </div>
              <div className="text-xs text-muted-foreground">{tShifts('okegawaShifts')}</div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* シフト削除用のダイアログ */}
      {editingShift && (
        <Dialog open={!!editingShift} onOpenChange={() => setEditingShift(null)}>
          <DialogContent className="sm:max-w-[400px]">
            <DialogHeader>
              <DialogTitle>{tShifts('shiftDetails')}</DialogTitle>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="text-muted-foreground">{tShifts('date')}:</span>
                  <p className="font-medium">{editingShift.date}</p>
                </div>
                <div>
                  <span className="text-muted-foreground">{tShifts('school')}:</span>
                  <p className="font-medium">
                    {editingShift.school === 'ageo' ? 'Ageo School' : 'Okegawa School'}
                  </p>
                </div>
                <div>
                  <span className="text-muted-foreground">{tShifts('coach')}:</span>
                  <p className="font-medium">{getCoachName(editingShift.coachId)}</p>
                </div>
                <div>
                  <span className="text-muted-foreground">{tShifts('lesson')}:</span>
                  <p className="font-medium">{editingShift.hasLesson ? tShifts('yes') : tShifts('no')}</p>
                </div>
              </div>
            </div>
            <DialogFooter>
              <Button 
                variant="destructive" 
                onClick={() => {
                  handleDeleteShift(editingShift.id)
                  setEditingShift(null)
                }}
              >
                <Trash2 className="h-4 w-4 mr-2" />
                {tShifts('delete')}
              </Button>
              <Button variant="outline" onClick={() => setEditingShift(null)}>
                {tShifts('close')}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}
    </div>
  )
}
