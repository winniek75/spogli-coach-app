// src/router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import HomeView from '../views/HomeView.vue'
import RhymingGame from '@/components/games/RhymingGame.vue'
import SyllableGame from '@/components/games/SyllableGame.vue'
import AlliterationGame from '@/components/games/AlliterationGame.vue'
import RhymeEndingGame from '@/components/games/RhymeEndingGame.vue'

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    {
      path: '/',
      name: 'home',
      component: HomeView
    },

    // ===========================================
    // ðŸŽµ ã‚µã‚¦ãƒ³ãƒ‰ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ ãƒ¡ã‚¤ãƒ³ãƒãƒ–
    // ===========================================
    {
      path: '/sound-adventure',
      name: 'SoundAdventureHub',
      component: () => import('../views/SoundAdventureHub.vue'),
      meta: {
        title: 'ã‚µã‚¦ãƒ³ãƒ‰ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼',
        description: 'éŸ³ã®ä¸–ç•Œã‚’å†’é™ºã—ã¦ã€è‹±èªžãƒžã‚¹ã‚¿ãƒ¼ã«ãªã‚ã†ï¼',
        requiresAuth: false,
        showInNav: true,
        icon: 'ðŸŽµ'
      }
    },

    // æ—§ãƒ«ãƒ¼ãƒˆï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”¨ï¼‰
    {
      path: '/sound-master',
      redirect: '/sound-adventure'
    },

    // ===========================================
    // ðŸï¸ ã‚ªãƒˆã®å³¶ - ã¯ã˜ã‚ã®å†’é™º
    // ===========================================
    {
      path: '/games/rhyming',
      name: 'rhyme-hunter',
      component: RhymingGame,
      meta: {
        title: 'ãƒ©ã‚¤ãƒ ãƒ»ãƒãƒ³ã‚¿ãƒ¼',
        description: 'éŸ»ã‚’è¸ã‚€å˜èªžã‚’ã‚­ãƒ£ãƒƒãƒã—ã‚ï¼',
        stage: 'island',
        difficulty: 'beginner',
        gameId: 'rhyming',
        icon: 'ðŸŽµ'
      }
    },
    {
      path: '/games/syllable',
      name: 'syllable-master',
      component: SyllableGame,
      meta: {
        title: 'ã‚·ãƒ©ãƒ–ãƒ«ãƒ»ãƒžã‚¹ã‚¿ãƒ¼',
        description: 'éŸ³ç¯€ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ãƒªã‚ºãƒ ã‚’ä½œã‚ã†ï¼',
        stage: 'island',
        difficulty: 'beginner',
        gameId: 'syllable',
        icon: 'ðŸ‘'
      }
    },

    // ===========================================
    // ðŸŒ² ãƒªã‚ºãƒ ã®æ£® - éŸ³ã®æŽ¢æ¤œéšŠ
    // ===========================================
    {
      path: '/games/alliteration',
      name: 'alliteration-ranger',
      component: AlliterationGame,
      meta: {
        title: 'é ­éŸ»ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼',
        description: 'åŒã˜éŸ³ã§å§‹ã¾ã‚‹ä»²é–“ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼',
        stage: 'forest',
        difficulty: 'intermediate',
        gameId: 'alliteration',
        icon: 'ðŸ…°ï¸'
      }
    },
    {
      path: '/games/rhyme-ending',
      name: 'end-sound-master',
      component: RhymeEndingGame,
      meta: {
        title: 'ã‚¨ãƒ³ãƒ‰ãƒ»ã‚µã‚¦ãƒ³ãƒ‰',
        description: 'èªžå°¾ã®éŸ³ã‚’ãƒžãƒƒãƒã•ã›ã‚ï¼',
        stage: 'forest',
        difficulty: 'intermediate',
        gameId: 'rhymeEnding',
        icon: 'ðŸ”š'
      }
    },
    {
      path: '/games/medial-sound',
      name: 'middle-catcher',
      component: () => import('@/components/games/MedialSoundGame.vue'),
      meta: {
        title: 'ãƒŸãƒ‰ãƒ«ãƒ»ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼',
        description: 'å˜èªžã®çœŸã‚“ä¸­ã®éŸ³ã‚’å½“ã¦ã‚ˆã†ï¼',
        stage: 'forest',
        difficulty: 'intermediate',
        gameId: 'medialSound',
        icon: 'ðŸŽ¯'
      }
    },

    // ===========================================
    // ðŸ° ã‚µã‚¦ãƒ³ãƒ‰åŸŽ - æœ€çµ‚è©¦ç·´
    // ===========================================
    {
      path: '/games/phonics-master',
      name: 'phonics-king',
      component: () => import('@/components/games/PhonicsKingGame.vue'),
      meta: {
        title: 'ãƒ•ã‚©ãƒ‹ãƒƒã‚¯ã‚¹ãƒ»ã‚­ãƒ³ã‚°',
        description: 'ç©¶æ¥µã®éŸ³éŸ»ãƒžã‚¹ã‚¿ãƒ¼ã«æŒ‘æˆ¦ï¼',
        stage: 'castle',
        difficulty: 'advanced',
        gameId: 'phonicsMaster',
        icon: 'ðŸ‘‘',
        requiresUnlock: true,
        unlockCondition: 'forest_80_percent'
      }
    },
    {
      path: '/games/speed-challenge',
      name: 'speed-lightning',
      component: () => import('@/components/games/SpeedChallengeGame.vue'),
      meta: {
        title: 'ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»ãƒãƒ£ãƒ¬ãƒ³ã‚¸',
        description: 'åˆ¶é™æ™‚é–“å†…ã«ç´ æ—©ãç­”ãˆã‚ˆã†ï¼',
        stage: 'castle',
        difficulty: 'advanced',
        gameId: 'speedChallenge',
        icon: 'âš¡',
        requiresUnlock: true,
        unlockCondition: 'forest_80_percent'
      }
    },
    {
      path: '/games/sound-master-final',
      name: 'ultimate-master',
      component: () => import('@/components/games/UltimateMasterGame.vue'),
      meta: {
        title: 'ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆãƒ»ãƒžã‚¹ã‚¿ãƒ¼',
        description: 'ã™ã¹ã¦ã®éŸ³éŸ»ã‚¹ã‚­ãƒ«ã‚’é§†ä½¿ã›ã‚ˆï¼',
        stage: 'castle',
        difficulty: 'expert',
        gameId: 'ultimateMaster',
        icon: 'ðŸŒŸ',
        requiresUnlock: true,
        unlockCondition: 'all_castle_complete'
      }
    },

    // ===========================================
    // ðŸŽ® è¿½åŠ ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰
    // ===========================================
    {
      path: '/games/word-rush',
      name: 'word-rush-adventure',
      component: () => import('../components/games/WordRushGame.vue'),
      meta: {
        title: 'ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ©ãƒƒã‚·ãƒ¥ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼',
        description: 'å˜èªžã‚’ç´ æ—©ãé¸æŠžã—ã¦ã‚¹ã‚³ã‚¢ã‚¢ãƒƒãƒ—ï¼',
        stage: 'bonus',
        difficulty: 'intermediate',
        gameId: 'wordRush',
        icon: 'ðŸ’¨'
      }
    },
    {
      path: '/games/pattern-builder',
      name: 'sentence-architect',
      component: () => import('../components/games/PatternBuilderGame.vue'),
      meta: {
        title: 'ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ',
        description: 'æ–‡æ³•ãƒ–ãƒ­ãƒƒã‚¯ã§å®Œç’§ãªæ–‡ã‚’ä½œã‚ã†ï¼',
        stage: 'bonus',
        difficulty: 'intermediate',
        gameId: 'patternBuilder',
        icon: 'ðŸ—ï¸'
      }
    },

    // æ—§ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒˆï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”¨ï¼‰
    {
      path: '/games/sound-master',
      redirect: '/sound-adventure'
    },

    // src/router/index.js ã®è©²å½“éƒ¨åˆ†ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£

    // ===========================================
    // ðŸŽ¯ ç‰¹åˆ¥ãƒ¢ãƒ¼ãƒ‰ãƒ»ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    // ===========================================

    // TODO: ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆå¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
    /*
    {
      path: '/challenges',
      name: 'daily-challenges',
      component: () => import('../views/DailyChallengesView.vue'),
      meta: {
        title: 'ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸',
        description: 'æ¯Žæ—¥å¤‰ã‚ã‚‹ç‰¹åˆ¥ãªæŒ‘æˆ¦ï¼',
        showInNav: true,
        icon: 'ðŸŽ¯'
      }
    },
    {
      path: '/challenges/weekly',
      name: 'weekly-tournament',
      component: () => import('../views/WeeklyTournamentView.vue'),
      meta: {
        title: 'ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒ»ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ',
        description: 'ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ç«¶äº‰ã—ã‚ˆã†ï¼',
        icon: 'ðŸ†'
      }
    },
    {
      path: '/vr-mode',
      name: 'vr-experience',
      component: () => import('../views/VRExperienceView.vue'),
      meta: {
        title: 'VRä½“é¨“ãƒ¢ãƒ¼ãƒ‰',
        description: 'ä»®æƒ³ç¾å®Ÿã§éŸ³ã®ä¸–ç•Œã«æ²¡å…¥ï¼',
        icon: 'ðŸ¥½',
        requiresVR: true
      }
    },
    */

    // ===========================================
    // ðŸ“Š ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãƒ»çµ±è¨ˆï¼ˆä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    // ===========================================

    // TODO: ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆå¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
    /*
    {
      path: '/profile',
      name: 'player-profile',
      component: () => import('../views/PlayerProfileView.vue'),
      meta: {
        title: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«',
        description: 'ã‚ãªãŸã®å†’é™ºã®è¨˜éŒ²',
        showInNav: true,
        icon: 'ðŸ‘¤'
      }
    },
    {
      path: '/progress',
      name: 'adventure-progress',
      component: () => import('../views/AdventureProgressView.vue'),
      meta: {
        title: 'å†’é™ºã®é€²æ—',
        description: 'ã‚ãªãŸã®æˆé•·ã‚’ç¢ºèªã—ã‚ˆã†',
        showInNav: true,
        icon: 'ðŸ“ˆ'
      }
    },
    {
      path: '/achievements',
      name: 'trophy-room',
      component: () => import('../views/TrophyRoomView.vue'),
      meta: {
        title: 'ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¼ãƒ ',
        description: 'ç²å¾—ã—ãŸå®Ÿç¸¾ã‚’ç¢ºèª',
        showInNav: true,
        icon: 'ðŸ†'
      }
    },
    {
      path: '/leaderboard',
      name: 'adventure-leaderboard',
      component: () => import('../views/LeaderboardView.vue'),
      meta: {
        title: 'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°',
        description: 'å†’é™ºè€…ãŸã¡ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°',
        icon: 'ðŸ¥‡'
      }
    },
    */

    // ===========================================
    // âš™ï¸ è¨­å®šãƒ»ã‚µãƒãƒ¼ãƒˆï¼ˆä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    // ===========================================

    // TODO: ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆå¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
    /*
    {
      path: '/settings',
      name: 'adventure-settings',
      component: () => import('../views/AdventureSettingsView.vue'),
      meta: {
        title: 'å†’é™ºã®è¨­å®š',
        description: 'ã‚²ãƒ¼ãƒ è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚º',
        showInNav: true,
        icon: 'âš™ï¸'
      }
    },
    {
      path: '/help',
      name: 'adventure-guide',
      component: () => import('../views/AdventureGuideView.vue'),
      meta: {
        title: 'å†’é™ºè€…ã‚¬ã‚¤ãƒ‰',
        description: 'ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹ã‚’å­¦ã¼ã†',
        icon: 'ðŸ“š'
      }
    },
    {
      path: '/about',
      name: 'about-adventure',
      component: () => import('../views/AboutAdventureView.vue'),
      meta: {
        title: 'ã‚µã‚¦ãƒ³ãƒ‰ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ã«ã¤ã„ã¦',
        description: 'ã‚¢ãƒ—ãƒªã®è©³ç´°æƒ…å ±',
        icon: 'â„¹ï¸'
      }
    },
    */

    // ===========================================
    // ðŸ”„ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    // ===========================================
    {
      path: '/loading',
      name: 'adventure-loading',
      component: () => import('../views/LoadingView.vue'),
      meta: {
        title: 'å†’é™ºæº–å‚™ä¸­...',
        hideFromNav: true
      }
    },
    {
      path: '/error',
      name: 'adventure-error',
      component: () => import('../views/ErrorView.vue'),
      meta: {
        title: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
        hideFromNav: true
      }
    },
    {
      path: '/:pathMatch(.*)*',
      name: 'not-found',
      component: () => import('../views/NotFoundView.vue'),
      meta: {
        title: 'ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
        hideFromNav: true
      }
    }
  ]
})

// ===========================================
// ðŸ›¡ï¸ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ãƒ¼ãƒ‰
// ===========================================

// ãƒ«ãƒ¼ãƒˆå¤‰æ›´å‰ã®å‡¦ç†
router.beforeEach(async (to, from, next) => {
  // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
  const title = to.meta.title ? `${to.meta.title} - ã‚µã‚¦ãƒ³ãƒ‰ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼` : 'ã‚µã‚¦ãƒ³ãƒ‰ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼'
  document.title = title

  // ãƒ¡ã‚¿ã‚¿ã‚°è¨­å®š
  updateMetaTags(to.meta)

  // VRè¦ä»¶ãƒã‚§ãƒƒã‚¯
  if (to.meta.requiresVR && !isVRSupported()) {
    console.warn('VRæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“')
    next({ name: 'sound-adventure-hub', query: { vrError: 'unsupported' } })
    return
  }

  // ã‚²ãƒ¼ãƒ è§£æ”¾æ¡ä»¶ãƒã‚§ãƒƒã‚¯
  if (to.meta.requiresUnlock && !checkUnlockCondition(to.meta.unlockCondition)) {
    console.warn(`ã‚²ãƒ¼ãƒ ãŒè§£æ”¾ã•ã‚Œã¦ã„ã¾ã›ã‚“: ${to.meta.unlockCondition}`)
    next({ name: 'sound-adventure-hub', query: { locked: to.meta.gameId } })
    return
  }

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆé‡ã„ãƒšãƒ¼ã‚¸ã®å ´åˆï¼‰
  if (to.meta.showLoading) {
    showLoadingScreen()
  }

  next()
})

// ãƒ«ãƒ¼ãƒˆå¤‰æ›´å¾Œã®å‡¦ç†
router.afterEach((to, from) => {
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éžè¡¨ç¤º
  hideLoadingScreen()

  // Google Analyticsï¼ˆå®Ÿè£…ã™ã‚‹å ´åˆï¼‰
  if (typeof gtag !== 'undefined') {
    gtag('config', 'GA_MEASUREMENT_ID', {
      page_title: to.meta.title,
      page_location: window.location.href
    })
  }

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒˆãƒƒãƒ—ã«
  window.scrollTo(0, 0)

  // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤çµ±è¨ˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  if (to.meta.gameId) {
    recordGameAccess(to.meta.gameId)
  }
})

// ===========================================
// ðŸ”§ ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
// ===========================================

// ãƒ¡ã‚¿ã‚¿ã‚°æ›´æ–°
function updateMetaTags(meta) {
  if (meta.description) {
    let descTag = document.querySelector('meta[name="description"]')
    if (!descTag) {
      descTag = document.createElement('meta')
      descTag.name = 'description'
      document.head.appendChild(descTag)
    }
    descTag.content = meta.description
  }
}

// VRã‚µãƒãƒ¼ãƒˆç¢ºèª
function isVRSupported() {
  return 'xr' in navigator && 'isSessionSupported' in navigator.xr
}

// ã‚²ãƒ¼ãƒ è§£æ”¾æ¡ä»¶ãƒã‚§ãƒƒã‚¯
function checkUnlockCondition(condition) {
  // ã“ã“ã§å®Ÿéš›ã®è§£æ”¾æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
  // ä¾‹: gameStore.checkUnlockCondition(condition)
  return true // ä¸€æ™‚çš„ã«trueã‚’è¿”ã™
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢è¡¨ç¤º/éžè¡¨ç¤º
function showLoadingScreen() {
  const loading = document.getElementById('loading-overlay')
  if (loading) loading.style.display = 'flex'
}

function hideLoadingScreen() {
  const loading = document.getElementById('loading-overlay')
  if (loading) loading.style.display = 'none'
}

// ã‚²ãƒ¼ãƒ ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²
function recordGameAccess(gameId) {
  // çµ±è¨ˆè¨˜éŒ²ï¼ˆå®Ÿè£…æ™‚ã« gameStore ã‚’ä½¿ç”¨ï¼‰
  console.log(`Game accessed: ${gameId}`)
}

// ===========================================
// ðŸŽ® ãƒ«ãƒ¼ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼
// ===========================================

// ã‚²ãƒ¼ãƒ ä¸€è¦§å–å¾—
export function getGameRoutes() {
  return router.getRoutes().filter(route => route.meta?.gameId)
}

// ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ã‚²ãƒ¼ãƒ å–å¾—
export function getGamesByStage(stage) {
  return router.getRoutes().filter(route => route.meta?.stage === stage)
}

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒ«ãƒ¼ãƒˆå–å¾—
export function getNavRoutes() {
  return router.getRoutes().filter(route => route.meta?.showInNav)
}

export default router